---
title: "Maricopa's Voters"
author: "Wesley Chioh"
date: "11/24/2020"
output: html_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(leaflet)
library(sf)
library(RColorBrewer)
library(ggplot2)
library(DT)
library(mapboxapi)

# reading in data
## Maricopa Co. data dump
maricopa_2020_11132020 <- read_tsv("Maricopa_2020_Provisional_111320.txt")
maricopa_2016 <- read_tsv("Maricopa_2016.txt")

## Maricopa Co. Voter Registration by Party
maricopa_2016_party_voter_registration <- read_csv("MaricopaCounty_2016_VoterRegPartyBreakdown.csv")
maricopa_2020_party_voter_registration <- read_csv("MaricopaCounty_2020_VoterRegPartyBreakdown.csv")


## Shapefiles
maricopa_precincts_2018 <- read_sf("./Shapefiles/VotingPrecincts/VotingPrecincts.shp")
maricopa_precincts_2018 <- st_transform(maricopa_precincts_2018, 4326)
maricopa_precincts_2016 <- read_sf("./Shapefiles/VotingPrecincts/HistoricalVotingPrecincts_12thru16.shp")
maricopa_precincts_2016 <- st_transform(maricopa_precincts_2016, 4326)
maricopa_cd <- read_sf("./Shapefiles/CD/MaricopaCD.shp")
maricopa_cd <- st_transform(maricopa_cd, 4326)
colnames(maricopa_cd)[1] <- "CD"
```

On October 6, 2020, the New York Times published an [article](https://www.nytimes.com/2020/10/06/opinion/biden-trump-bellwether-counties-.html?searchResultPosition=1) outlining the 10 bellwether counties for the 2020 Presidential elections. On the list was Maricopa County, AZ, which accounts for almost two-thirds of Arizona's population. As it turned out, Arizona did become a battleground state the President-Elect Biden flipped from Republican to Democratic, and Maricopa County provided him with the votes to do so.  
  
Now that the dust has settled somewhat, what we want to know are:  
1. How did Maricopa Co. voted as a whole this election as compared to 2016?  
2. Did Maricopa Co.'s  8 congressional  districts vote very differently from one another?  
3. How many new voters were registered between 2016 and 2020, and in which congressional districts can they be found?
  
Parts of this analysis are scaled to Maricopa County's 8 congressional districts to be consistent across electoral cycles, even though they are of different sizes. This is because Maricopa County is further divided into more than 700 electoral precincts. Ideally, we would compare precincts over the two elections. Complicating this effort, however, is the fact that the number of precincts have increased since 2016 and the boundaries have changed. What has remained constant, however, are the boundaries of congressional districts. Furthermore, the Maricopa County Recorder's Office and the AZ Secretary of State keep records on voter registration by congressional districts.   

```{r extraction fns, echo = FALSE}
# extracting congressional candidate per precinct
congress_2020 <- function(results){
  voteshare_df <- results %>%
    filter(str_detect(ContestName, "^US Rep"),
           CandidateAffiliation %in% c("REP", "DEM")) %>%
    select(PrecinctId, PrecinctName, ContestName, CandidateName, Votes, `Votes_EARLY VOTE`, `Votes_ELECTION DAY`, Votes_PROVISIONAL, `Turnout_EARLY VOTE`, `Turnout_ELECTION DAY`, Registered, Turnout, TurnoutPerc) %>%
    na.omit()
}

congress_2016 <- function(results, CONTEST_FULL_NAME){
  voteshare_df <- results %>%
    filter(str_detect(CONTEST_FULL_NAME, "^US Rep"),
           candidate_party_id %in% c(1, 2)) %>%
    select(PRECINCT_NAME, CONTEST_FULL_NAME, CANDIDATE_FULL_NAME, TOTAL, CONTEST_TOTAL) %>%
    na.omit()
}

# extracting congressional race per precinct
## separate functions have to be written for 2016 and 2020 because the reporting format was different
cd_per_precinct <- function(cd_results){
  cd_per_precinct <- cd_results %>%
    select(PrecinctName, ContestName) %>%
    unique()
  cd_per_precinct <- cd_per_precinct %>%
    group_by(PrecinctName) %>%
    mutate(PrecinctId = substr(PrecinctName, 1, 4),
           PrecinctName = substr(PrecinctName, 6, nchar(PrecinctName)),
           ContestName = substr(ContestName, 16, 16))
  colnames(cd_per_precinct) <- c("PrecinctName", "CD", "PrecinctId")
  cd_per_precinct
}

cd_per_precinct_2016 <- function(cd_results){
  cd_per_precinct <- cd_results %>%
    select(PRECINCT_NAME, CONTEST_FULL_NAME) %>%
    unique()
  cd_per_precinct <- cd_per_precinct %>%
    group_by(PRECINCT_NAME) %>%
    mutate(PRECINCT_ID = substr(PRECINCT_NAME, 1,4),
           PRECINCT_NAME = substr(PRECINCT_NAME, 6, nchar(PRECINCT_NAME)),
           CONTEST_FULL_NAME = substr(CONTEST_FULL_NAME, 15, 15)) %>%
    ungroup()
  colnames(cd_per_precinct) <- c("PrecinctName", "CD", "PrecinctId")
  cd_per_precinct <- cd_per_precinct[,c(3,1,2)]
  cd_per_precinct
}

# extracting presidential candidate and calculating pct votes
presidential <- function(results){
  voteshare_df <- results %>%
    filter(ContestName == "Presidential Electors",
           CandidateId %in% c(1, 2)) %>%
    select(PrecinctId, PrecinctName, CandidateName, Votes, `Votes_EARLY VOTE`, `Votes_ELECTION DAY`, Votes_PROVISIONAL, `Turnout_EARLY VOTE`, `Turnout_ELECTION DAY`, Registered, Turnout, TurnoutPerc) %>%
    na.omit()
  voteshare_df <- voteshare_df %>%
    group_by(PrecinctId) %>%
    mutate(PrecinctId = substr(PrecinctName, 1, 4),
           PrecinctName = substr(PrecinctName, 6, nchar(PrecinctName))) %>%
    ungroup()
  
  voteshare_df
}

presidential_2020_other_candidates <- function(results){
  voteshare_df <- results %>%
    filter(ContestName == "Presidential Electors",
           !CandidateId %in% c(1, 2)) %>%
    select(PrecinctId, PrecinctName, CandidateName, Votes, `Votes_EARLY VOTE`, `Votes_ELECTION DAY`, Votes_PROVISIONAL, `Turnout_EARLY VOTE`, `Turnout_ELECTION DAY`, Registered, Turnout, TurnoutPerc) %>%
    na.omit()
  voteshare_df <- voteshare_df %>%
    group_by(PrecinctId) %>%
    mutate(PrecinctId = substr(PrecinctName, 1, 4),
           PrecinctName = substr(PrecinctName, 6, nchar(PrecinctName))) %>%
    ungroup()
  
  voteshare_df
}

presidential_2016 <- function(results){
  voteshare_df <- results %>%
    filter(CONTEST_FULL_NAME == "Presidential Electors",
           candidate_party_id %in% c(1, 2)) %>%
    select(PRECINCT_NAME, CANDIDATE_FULL_NAME, TOTAL, CONTEST_TOTAL)
  voteshare_df <- voteshare_df %>%
    mutate(PrecinctId = substr(PRECINCT_NAME, 1,4),
           PrecinctName = substr(PRECINCT_NAME, 6, nchar(PRECINCT_NAME))) %>%
    select(PrecinctId, PrecinctName, CANDIDATE_FULL_NAME, TOTAL, CONTEST_TOTAL)
  voteshare_df
}

presidential_2016_other_candidates <- function(results){
  voteshare_df <- results %>%
    filter(CONTEST_FULL_NAME == "Presidential Electors",
           !candidate_party_id %in% c(1, 2)) %>%
    select(PRECINCT_NAME, CANDIDATE_FULL_NAME, TOTAL, CONTEST_TOTAL)
  voteshare_df <- voteshare_df %>%
    mutate(PrecinctId = substr(PRECINCT_NAME, 1,4),
           PrecinctName = substr(PRECINCT_NAME, 6, nchar(PRECINCT_NAME))) %>%
    select(PrecinctId, PrecinctName, CANDIDATE_FULL_NAME, TOTAL, CONTEST_TOTAL)
  voteshare_df
}

candidate_voteshare <- function(results, candidate){
  voteshare_df <- results %>%
    filter(CandidateName == candidate) %>%
    mutate(PctVotes = round(Votes/Turnout, 2),
           PrecinctId = substr(PrecinctName, 1, 4))
  
  voteshare_df
}
```
  
```{r extraction, echo=FALSE, message=FALSE}
# latest data dump
maricopa_2020_11132020_congress <- maricopa_2020_11132020 %>%
  congress_2020()

maricopa_2016_congress <- maricopa_2016 %>%
  congress_2016()

cd_per_precinct_2020 <- maricopa_2020_11132020_congress %>%
  cd_per_precinct()

cd_per_precinct_2016 <- maricopa_2016_congress %>%
  cd_per_precinct_2016()

maricopa_2020_11132020_narrow <- maricopa_2020_11132020 %>%
  presidential()

maricopa_2020_dems_111320 <- maricopa_2020_11132020_narrow %>%
  candidate_voteshare(., "BIDEN / HARRIS")

maricopa_2020_reps_111320 <- maricopa_2020_11132020_narrow %>%
  candidate_voteshare(., "TRUMP / PENCE")

maricopa_2016_presidential <- maricopa_2016 %>% 
  presidential_2016()

maricopa_2020_11132020_narrow <- inner_join(maricopa_2020_11132020_narrow, cd_per_precinct_2020)

maricopa_2016_presidential <- inner_join(maricopa_2016_presidential, cd_per_precinct_2016)

# non dem/rep
maricopa_2020_11132020_3parties <- maricopa_2020_11132020 %>%
  presidential_2020_other_candidates() %>%
  group_by(PrecinctId, PrecinctName) %>%
  summarise(total_3p_votes = sum(Votes))
maricopa_2020_11132020_3parties <- inner_join(maricopa_2020_11132020_3parties, cd_per_precinct_2020)

maricopa_2016_3parties <- maricopa_2016 %>%
  presidential_2016_other_candidates() %>%
  group_by(PrecinctId, PrecinctName) %>%
  summarise(total_3p_votes = sum(TOTAL))
maricopa_2016_3parties <- inner_join(maricopa_2016_3parties, cd_per_precinct_2016)
```

### Mapping the Vote  
  
Using the `mapboxapi` and `leaflet` packages in R, shapefiles of congressional districts in Arizona and election results downloaded from the Maricopa County Recorder Office's website, I was able to produce the following map. The map aggregates results from the Presidential Elections in both 2016 and 2020 at the geographical scale of congressional districts. The colors represent the percentage of votes obtained by each candidate pair.   
```{r, map, echo = FALSE, message=FALSE}
## joining elections data
maricopa_2016_rep <- maricopa_2016_presidential_congress %>%
  filter(party == "REP")
maricopa_2016_dem <- maricopa_2016_presidential_congress %>%
  filter(party == "DEM")  
maricopa_2020_rep <- maricopa_2020_11132020_presidential_congress %>%
  filter(party == "REP")
maricopa_2020_dem <- maricopa_2020_11132020_presidential_congress %>%
  filter(party == "DEM")  

maricopa_cd_2016_rep <- inner_join(maricopa_cd, maricopa_2016_rep)
maricopa_cd_2016_dem <- inner_join(maricopa_cd, maricopa_2016_dem)
maricopa_cd_2020_rep <- inner_join(maricopa_cd, maricopa_2020_rep)
maricopa_cd_2020_dem <- inner_join(maricopa_cd, maricopa_2020_dem)

## color bins
bins <- c(0, 20, 30, 40, 50, 60, 70, 80, 100)
rep16_pal <- colorBin("Reds", domain = maricopa_2016_rep$votes_pct_2016, bins = bins)
rep20_pal <- colorBin("Reds", domain = maricopa_2020_rep$votes_pct_2020, bins = bins)
dem16_pal <- colorBin("Blues", domain = maricopa_2016_dem$votes_pct_2016, bins = bins)
dem20_pal <- colorBin("Blues", domain = maricopa_2020_dem$votes_pct_2020, bins = bins)

## geolocating phoenix
phoenix <- mb_geocode("Phoenix")

## setting up map
maricopa_map <- leaflet() %>%
  addMapboxTiles(style_id = "streets-v11",
                 username = "mapbox") %>%
  addPolygons(data = maricopa_cd, label = ~paste("CD: ",CD, sep = ""), group = "Congressional District") %>%
  addPolygons(data = maricopa_cd_2016_rep, label = ~paste("CD ", CD, ": ", votes_pct_2016, "%", sep = ""), 
              group = "Republicans - 2016", fillColor = ~rep20_pal(votes_pct_2016), fillOpacity = 0.75,
              weight = 0, opacity = 0, color = "white") %>%
  addPolygons(data = maricopa_cd_2016_dem, label = ~paste("CD ", CD, ": ", votes_pct_2016, "%", sep = ""), 
              group = "Democrats - 2016", fillColor = ~dem20_pal(votes_pct_2016), fillOpacity = 0.75,
              weight = 0, opacity = 0, color = "white") %>%
  addPolygons(data = maricopa_cd_2020_rep, label = ~paste("CD ", CD, ": ", votes_pct_2020, "%", sep = ""), 
              group = "Republicans - 2020", fillColor = ~rep20_pal(votes_pct_2020), fillOpacity = 0.75,
              weight = 0, opacity = 0, color = "white") %>%
  addPolygons(data = maricopa_cd_2020_dem, label = ~paste("CD ", CD, ": ", votes_pct_2020, "%", sep = ""), 
              group = "Democrats - 2020", fillColor = ~dem20_pal(votes_pct_2020), fillOpacity = 0.75,
              weight = 0, opacity = 0, color = "white") %>%
  addLegend("bottomright", pal = dem20_pal, values = maricopa_2020_dem$votes_pct_2020, title = "Dem Vote Share (%)", 
            opacity = 0.7, group = "Democrats - 2016") %>%
  addLegend("bottomleft", pal = rep20_pal, values = maricopa_2020_rep$votes_pct_2020, title = "Rep Vote Share (%)", 
            opacity = 0.7, group = "Republicans - 2016") %>%
  addLegend("bottomright", pal = dem20_pal, values = maricopa_2020_dem$votes_pct_2020, title = "Dem Vote Share (%)", 
            opacity = 0.7, group = "Democrats - 2020") %>%
  addLegend("bottomleft", pal = rep20_pal, values = maricopa_2020_rep$votes_pct_2020, title = "Rep Vote Share (%)", 
            opacity = 0.7, group = "Republicans - 2020") %>%
  addLayersControl(overlayGroups = c("Congressional District", "Republicans - 2016", "Democrats - 2016", 
                                     "Republicans - 2020", "Democrats - 2020"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
  hideGroup(c("Republicans - 2016", "Democrats - 2016", "Republicans - 2020", "Democrats - 2020")) %>%
  setView(lng = phoenix[1], lat = phoenix[2], zoom = 8.5)


```  
  
What we can observe from this map is that for the most part, electoral support for Trump has remained steady between 2016 and 2020 in all congressional districts. What has appeared to happen is a strengthening of support for the Democrats, especially in Congressional Districts 3, 5, and 8, at the expense of third-party candidates such as the Libertarians.    

## Congressional Districts in Maricopa County  
  
Aggregating presidential results by congressional districts, we get the following:  
  
1. Republican vote share has remained remarkably steady between 2016 and 2020.  
2. Both sides increased turnout.  
3. Democrats won not by peeling off Republicans but by peeling off third party voters whose vote share has collapsed unlike elsewhere. 
  
```{r, echo = FALSE}
## Maricopa 2016
maricopa_2016_presidential_congress <- maricopa_2016_presidential %>%
  group_by(CD, CANDIDATE_FULL_NAME) %>%
  summarise(total_votes = sum(CONTEST_TOTAL),
            votes_candidate = sum(TOTAL)) %>%
  mutate(votes_pct = round(100*votes_candidate/total_votes),
         party = substr(CANDIDATE_FULL_NAME, 1, 3))
colnames(maricopa_2016_presidential_congress) <- c("CD", "Candidate_2016", "total_votes_2016", "votes_candidate_2016", "votes_pct_2016", "party")

maricopa_2016_3parties_congress <- maricopa_2016_3parties %>%
  group_by(CD) %>%
  summarize(total_3p_votes_2016 = sum(total_3p_votes))

## Maricopa 2020
maricopa_2020_11132020_presidential_congress <- maricopa_2020_11132020_narrow %>%
  group_by(CD, CandidateName) %>%
  summarise(total_votes = sum(Turnout),
            votes_candidate = sum(Votes)) %>%
  mutate(votes_pct = round(100*votes_candidate/total_votes),
         party = ifelse(CandidateName == "BIDEN / HARRIS", "DEM", "REP"))
colnames(maricopa_2020_11132020_presidential_congress) <- c("CD", "Candidate_2020", "total_votes_2020", "votes_candidate_2020", "votes_pct_2020", "party")

maricopa_2020_11132020_3parties_congress <- maricopa_2020_11132020_3parties %>%
  group_by(CD) %>%
  summarize(total_3p_votes_2020 = sum(total_3p_votes))


## comparing
maricopa_comparison <- inner_join(maricopa_2020_11132020_presidential_congress, maricopa_2016_presidential_congress)
maricopa_comparison <- inner_join(maricopa_comparison, maricopa_2016_3parties_congress)
maricopa_comparison <- inner_join(maricopa_comparison, maricopa_2020_11132020_3parties_congress)
maricopa_comparison <- maricopa_comparison %>%
  select(CD, party, total_votes_2016, total_votes_2020, votes_candidate_2016, votes_candidate_2020, votes_pct_2016, votes_pct_2020, total_3p_votes_2016, total_3p_votes_2020)

maricopa_comparison %>%
  kbl() %>%
  kable_minimal()
```
  
The next questions to ask are:  
1. Who registered more newer voters between 2018 and 2020? 
2. Where did the new voters come from?  
  
```{r, echo = FALSE}
maricopa_2016_voter_registration <- maricopa_2016 %>%
  filter(contest_id == 0) %>%
  select(PRECINCT_NAME, CONTEST_TOTAL) %>%
  unique() %>%
  mutate(PRECINCT_ID = substr(PRECINCT_NAME, 1, 4),
         PRECINCT_NAME = substr(PRECINCT_NAME, 6, nchar(PRECINCT_NAME)))
colnames(maricopa_2016_voter_registration) <- c("PrecinctName", "PrecinctRegistered", "PrecinctId")
maricopa_2016_voter_registration <- inner_join(maricopa_2016_voter_registration, cd_per_precinct_2016)
maricopa_2016_voter_registration_CD <- maricopa_2016_voter_registration %>%
  group_by(CD) %>%
  summarise(registered_voters_2016 = sum(PrecinctRegistered))

maricopa_2020_11132020_voter_registration <- maricopa_2020_11132020 %>%
  select(PrecinctName, PrecinctRegistered) %>%
  unique() %>%
  mutate(PrecinctId = substr(PrecinctName, 1, 4),
         PrecinctName = substr(PrecinctName, 6, nchar(PrecinctName)))
maricopa_2020_voter_registration <- inner_join(maricopa_2020_11132020_voter_registration, cd_per_precinct_2020)
maricopa_2020_voter_registration_CD <- maricopa_2020_voter_registration %>%
  group_by(CD) %>%
  summarise(registered_voters_2020 = sum(PrecinctRegistered))

maricopa_voter_comparison_CD <- inner_join(maricopa_2020_voter_registration_CD, maricopa_2016_voter_registration_CD)
maricopa_voter_comparison_CD <- maricopa_voter_comparison_CD %>%
  mutate(gains = registered_voters_2020 - registered_voters_2016,
         gains_pct = round(gains/registered_voters_2016, 2))
```
  
Using data from the recorder's office and the secretary of state, I was able to analyze the changes in the number of voter registrations. We can further break it down into party affiliations.  
  
```{r}
active_2016_voter_reg <- maricopa_2016_party_voter_registration %>%
  filter(Status == "ACTIVE") %>%
  mutate(OTH = GRN + OTH + LBT) %>%
  select(CD, REP, DEM, OTH, TOTALS)
colnames(active_2016_voter_reg) <- c("CD", "Rep_16", "Dem_16", "Others_16", "Totals_16")

active_2020_voter_reg <- maricopa_2020_party_voter_registration %>%
  filter(STATUS == "ACTIVE") %>%
  mutate(OTH = LBT + OTH) %>%
  select(CD, REP, DEM, OTH, TOTALS)
colnames(active_2020_voter_reg) <- c("CD", "Rep_20", "Dem_20", "Others_20", "Totals_20")

active_2020_voter_reg_pct <- active_2020_voter_reg %>%
  mutate(Rep_20 = round(100*Rep_20/Totals_20),
         Dem_20 = round(100*Dem_20/Totals_20),
         Others_20 = round(100*Others_20/Totals_20))

active_voter_reg_comparison <- inner_join(active_2016_voter_reg, active_2020_voter_reg)
active_voter_reg_comparison <- active_voter_reg_comparison %>%
  mutate(Rep = Rep_20 - Rep_16,
         Dem = Dem_20 - Dem_16,
         Oth = Others_20 - Others_16,
         Totals = Totals_20 - Totals_16) %>%
  select(CD, Rep, Dem, Oth, Totals)


```

